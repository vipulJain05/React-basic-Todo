name: Manual-cypress

on:
  workflow_dispatch:
    inputs:
      cluster_to_deploy:
        description: "Choose cluster to deploy to"
        required: true
        default: "test"
      tags:
        description: 'Run Cypress Test'
        required: false 
        type: boolean
        default: true
jobs:

  test:
    name: cypress-run
    # run: echo "${{ github.event.inputs.tags }}"
    if: ${{ github.event.inputs.tags}}
    runs-on: ubuntu-latest
    # strategy:
    #   fail-fast: false
    #   matrix:
    #     # count can be increased once we increase tests
    #     # e.g. [1,2,3]
    #     containers: [1,2,3,4]
    steps:
      - name: Set time
        run: |
          echo "${{ github.event.inputs.tags }}"
      
      # - name: Create file status_job02.txt and write the job status into it
      #   if: always()
      #   run: |
      #     echo "${{ job.status }}" > status_job02.txt

      # - name: Upload file status_job02.txt as an artifact
      #   if: always()
      #   uses: actions/upload-artifact@v1
      #   with:
      #     name: pass_status_job02
      #     path: status_job02.txt
      # - name: Checkout
      #   uses: actions/checkout@v2

    #   - name: Increase file watchers
    #     run: echo fs.inotify.max_user_watches=524288 | sudo tee -a /etc/sysctl.conf && sudo sysctl -p

    #   - name: Curate cypress config
    #     run: mv packages/web-app/cypress.ghactions.json packages/web-app/cypress.json


    #   - name: Cypress run 2
    #     uses: cypress-io/github-action@v2

    #     with:
    #       start: "yarn ws:app start:ghactions"
    #       wait-on: "http://localhost:3000"

    #       # hardcoded timeout to wait for 400 seconds before pinging local server
    #       wait-on-timeout: 400
    #       command: yarn ws:app cy:run 

    #   - name: Upload ss
    #     uses: actions/upload-artifact@v2
    #     if: failure()
    #     with:
    #       name: cypress-screenshots
    #       path: /home/runner/work/mmc-react-web/mmc-react-web/packages/web-app/cypress/screenshots/**
    #       retention-days: 1
      
    #   - name: Upload Videos
    #     uses: actions/upload-artifact@v2
    #     if: failure()
    #     with:
    #       name: cypress-videos
    #       path: /home/runner/work/mmc-react-web/mmc-react-web/packages/web-app/cypress/videos/**
    #       retention-days: 1

  build:
    # if: ${{ github.event.label.name == 'cypress test ready' }} || ${{github.event.pull_request}}
    runs-on: ubuntu-latest
    needs: [test]
    steps:
    # - name: Download artifact pass_status_job01
    #     uses: actions/download-artifact@v1
    #     with:
    #       name: pass_status_job02

    # - name: Set the statuses of Job 01 and Job 02 as output parameters
    #     id: set_outputs
    #     run: |
    #       echo "::set-output name=status_job02::$(<pass_status_job02/status_job02.txt)"

    # - name: Show the values of the outputs
    #   run: |
    #     echo "status_job02 = ${{ steps.set_outputs.outputs.status_job02 }}"

    - uses: actions/checkout@v2

    # - name: Configure AWS credentials
    #   uses: aws-actions/configure-aws-credentials@v1
    #   with:
    #     aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
    #     aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
    #     aws-region: us-east-2

    - name: Set time
      run: |
        echo "${{ needs.test.outputs }}"
        echo "${{github.jobs[0].conclusion}}"
        
